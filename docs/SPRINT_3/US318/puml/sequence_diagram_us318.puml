@startuml
actor "CRM Manager" as User
participant "ConfigureProposalDocumentUI" as UI
participant "ConfigureProposalDocumentController" as Controller
participant "PersistenceContext" as Persistence
participant "RepositoryFactory" as Factory
participant "ProposalDocumentGenerator" as Generator
participant "DocumentGenerationPlugin" as Plugin
participant "ShowProposalRepository" as Repo
participant "ShowProposal" as Proposal

activate User

User -> UI : request template configuration
activate UI

UI -> Controller : configurableProposalList()
activate Controller

Controller -> Persistence : PersistenceContext()
activate Persistence

Persistence -> Factory : repositories()
deactivate Persistence

activate Factory
Factory -> Repo : proposals()
deactivate Factory

activate Repo
Repo -> Repo : findConfigurableProposals()

Repo --> Controller : list of proposals
deactivate Repo

Controller --> UI : proposals
deactivate Controller

UI -> User : show proposals and templates
User -> UI : select proposal and template
UI -> Controller: configureDocument(proposal, selectedTemplate, crmManager)

activate Controller

Controller -> Proposal: configureDocument(selectedTemplate, crmManager);
activate Proposal

Proposal -> Controller : documentTemplateContent
deactivate Proposal

Controller -> Generator : generateDocument(documentTemplateContent)

activate Generator
Generator -> Plugin : processDocument(documentTemplateContent)

activate Plugin
Plugin --> Generator : showProposalDocument(content + path)
deactivate Plugin

Generator --> Controller : showProposalDocument
deactivate Generator

Controller -> Proposal : addDocument(showProposalDocument)
activate Proposal
deactivate Proposal

Controller -> Repo : save(proposal)
activate Repo
Repo --> Controller : confirmation
deactivate Repo

Controller --> UI : true
UI --> User : show success message

deactivate Controller
deactivate UI
deactivate User
@enduml
