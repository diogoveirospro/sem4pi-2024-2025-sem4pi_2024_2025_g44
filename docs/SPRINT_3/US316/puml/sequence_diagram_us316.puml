@startuml
actor "CRM Collaborator" as User
participant "SendProposalUI" as UI
participant "SendProposalController" as Controller
participant "PersistenceContext" as Persistence
participant "RepositoryFactory" as Factory
participant "ShowProposalRepository" as ProposalRepo
participant "ProposalDeliveryInfoRepository" as DeliveryRepo
participant "ProposalDelivery" as DeliveryService
participant "ProposalDeliveryInfo" as DeliveryInfo

activate User

User -> UI : request to send proposal
activate UI

UI -> Controller : fetch proposals ready to send
activate Controller

Controller -> Persistence : PersistenceContext()
activate Persistence

Persistence -> Factory : repositories()
deactivate Persistence

activate Factory
Factory -> ProposalRepo : proposals()
activate ProposalRepo

ProposalRepo -> ProposalRepo : findProposalsReadyToSend()
Factory -> DeliveryRepo : delivery()
deactivate Factory
activate DeliveryRepo

deactivate DeliveryRepo
deactivate DeliveryRepo


ProposalRepo --> Controller : list of proposals
deactivate ProposalRepo

Controller --> UI : proposals
deactivate Controller

UI -> User : show proposals
User -> UI : select proposal

UI -> Controller : sendProposal(proposal)
activate Controller

Controller -> DeliveryService : generateDeliveryInfo(proposal)
activate DeliveryService

DeliveryService -> DeliveryInfo : create with proposal, customer, code
activate DeliveryInfo
DeliveryInfo --> DeliveryService : new DeliveryInfo
deactivate DeliveryInfo

DeliveryService -> DeliveryRepo : save(DeliveryInfo)
deactivate DeliveryService

DeliveryRepo --> Controller : confirmation
deactivate DeliveryRepo

alt Proposal is sent
    Controller --> UI : show success + delivery code
    UI --> User : show success message and code
else Proposal is not sent
    Controller --> UI : error
    UI --> User : show error (e.g., missing doc/video)
end

deactivate Controller
deactivate UI
deactivate User
@enduml
