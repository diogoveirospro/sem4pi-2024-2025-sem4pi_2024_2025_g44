@startuml
actor "Customer" as User
participant "SendFeedbackProposalUI" as UI
participant "SendFeedbackProposalController" as Controller
participant "CustomerAppProtocolProxy" as Proxy
participant "GetShodroneUserRequest" as RequestUser
participant "ClientSocket" as Socket
participant "CustomerAppServer" as Server
participant "CustomerAppMessageParser" as Parser
participant "UserAppServerController" as ServerController
participant "ShodroneUserRepository" as ShodroneUserRepo
participant "MarshallerUnmarshaller" as MU
participant "ShodroneUserDTO" as UserDTO
participant "GetCustomerOfRepresentativeRequest" as GetCustomerRequest
participant "CustomerDTO" as CustomerDTO
participant "CustomerRepository" as CustomerRepo
participant "GetProposalsOfCustomerRequest" as GetProposalsRequest
participant "DeliveryReportingRepository" as DeliveryRepo
participant "ProposalDTO" as ProposalDTO
participant "SendFeedbackProposalRequest" as Request
participant "ShowProposalRepository" as ProposalRepo
participant "SendFeedbackProposalResponse" as Response

activate User

User -> UI : request to accept/reject pending proposals
activate UI

UI -> Controller : listProposals()
activate Controller

Controller -> Proxy : getShodroneUser(authenticatedUser)
activate Proxy

Proxy -> RequestUser : toRequest(authenticatedUser)
activate RequestUser
deactivate RequestUser

Proxy -> Socket : sendAndReceive(request)
activate Socket

Socket -> Server : send(request)
activate Server

Server -> Parser : parse(request)
activate Parser

Server -> Parser : execute(request)

Parser -> ServerController : getShodroneUserByUsername(username)
activate ServerController

ServerController -> ShodroneUserRepo : findByUsername(username)
activate ShodroneUserRepo
deactivate ShodroneUserRepo

ServerController --> Parser : response
deactivate ServerController

Parser --> Server : response
deactivate Parser

Server --> Socket : response
deactivate Server

Socket --> Proxy : response
deactivate Socket

Proxy -> MU : parseResponseMessageShodroneUser(response)
activate MU

MU -> UserDTO : ShodroneUserDTO()
activate UserDTO
deactivate UserDTO

MU --> Proxy : parseResponseMessageLineShodroneUser(response)
deactivate MU

Proxy --> Controller : shodroneUser
deactivate Proxy



Controller -> Proxy : getCustomerOfRepresentative(shodroneUser)
activate Proxy

Proxy -> GetCustomerRequest : toRequest(authenticatedUser)
activate GetCustomerRequest
deactivate GetCustomerRequest

Proxy -> Socket : sendAndReceive(request)
activate Socket

Socket -> Server : send(request)
activate Server

Server -> Parser : parse(request)
activate Parser

Server -> Parser : execute(request)

Parser -> ServerController : getCustomerByRepresentativeEmail(repEmail)
activate ServerController

ServerController -> CustomerRepo : findCustomerByRepresentativeEmail(repEmail)
activate CustomerRepo
deactivate CustomerRepo

ServerController --> Parser : response
deactivate ServerController

Parser --> Server : response
deactivate Parser

Server --> Socket : response
deactivate Server

Socket --> Proxy : response
deactivate Socket

Proxy -> MU : parseResponseMessageCustomer(response)
activate MU

MU -> CustomerDTO : CustomerDTO()
activate CustomerDTO
deactivate CustomerDTO

MU --> Proxy : parseResponseMessageLineCustomer(response)
deactivate MU



Proxy --> Controller : customer
deactivate Proxy

Controller -> Proxy : getProposalsDelivered(customer)
activate Proxy

Proxy -> GetProposalsRequest : toRequest(customer)
activate GetProposalsRequest
deactivate GetProposalsRequest

Proxy -> Socket : sendAndReceive(request)
activate Socket

Socket -> Server : send(request)
activate Server

Server -> Parser : parse(request)
activate Parser

Server -> Parser : execute(request)

Parser -> ServerController : getDeliveryProposalsOfCustomer(vatNumber)
activate ServerController

ServerController -> DeliveryRepo : findAllProposalsByCustomer(vatNumber)
activate DeliveryRepo
deactivate DeliveryRepo

ServerController --> Parser : response
deactivate ServerController

Parser --> Server : response
deactivate Parser

Server --> Socket : response
deactivate Server

Socket --> Proxy : response
deactivate Socket

Proxy -> MU : parseResponseMessageProposal(response)
activate MU

MU -> ProposalDTO : ProposalDTO()
activate ProposalDTO
deactivate ProposalDTO

MU --> Proxy : parseResponseMessageLineShow(response)
deactivate MU

Proxy --> Controller : proposals
deactivate Proxy

Controller --> UI : proposals
deactivate Controller



UI --> User : asks to select a proposal

User -> UI : selects a proposal

UI --> User : asks feedback on proposal

User -> UI : accept/reject + feedback



UI -> Controller : sendFeedbackProposal(proposalNumber, decision, feedback)
activate Controller

Controller -> Proxy : sendFeedbackProposal(proposalNumber, decision, feedback)
activate Proxy

Proxy -> Request : toRequest(proposalNumber, decision, feedback)
activate Request
deactivate Request

Proxy -> Socket : sendAndReceive(request)
activate Socket

Socket -> Server : send(request)
activate Server

Server -> Parser : parse(request)
activate Parser

Server -> Parser : execute(request)

Parser -> ServerController : handleProposalFeedback(proposalNumber, decision, feedback)
activate ServerController

ServerController -> ProposalRepo : updateProposalStatusAndFeedback(proposalNumber, decision, feedback)
activate ProposalRepo
deactivate ProposalRepo

ServerController --> Parser : response
deactivate ServerController

Parser --> Server : response
deactivate Parser

Server --> Socket : response
deactivate Server

Socket --> Proxy : response
deactivate Socket

Proxy -> MU : parseResponseMessageFeedback(response)
activate MU

MU -> Response : FeedbackProposalResponse()
activate Response
deactivate Response

MU --> Proxy : parseResponse()
deactivate MU

Proxy --> Controller : accepted/rejected
deactivate Proxy

Controller --> UI : show confirmation
deactivate Controller

UI --> User : confirmation: feedback successfully submitted
deactivate UI
deactivate User

@enduml